openapi: 3.1.0
info:
  title: IPFS Cluster Orchestrator API
  version: 1.0.0
  description: >
    API для управления кластером IPFS в Kubernetes.
    Используется фронтендом (React Canvas) для создания, обновления и мониторинга кластеров.

servers:
  - url: http://localhost:8080/v1
    description: Local Dev

tags:
  - name: Clusters
    description: Управление IPFS кластерами
  - name: Nodes
    description: Управление нодами внутри кластера

paths:

  /clusters:
    get:
      tags: [Clusters]
      summary: Получить список всех кластеров
      responses:
        "200":
          description: Список кластеров
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Cluster"

    post:
      tags: [Clusters]
      summary: Создать новый кластер
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClusterCreateRequest"
      responses:
        "201":
          description: Кластер создан
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cluster"
        "400":
          description: Ошибка валидации

  /clusters/{clusterId}:
    get:
      tags: [Clusters]
      summary: Информация о кластере
      parameters:
        - $ref: "#/components/parameters/ClusterId"
      responses:
        "200":
          description: Информация о кластере
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cluster"
        "404":
          description: Кластер не найден

    delete:
      tags: [Clusters]
      summary: Удалить кластер
      parameters:
        - $ref: "#/components/parameters/ClusterId"
      responses:
        "204":
          description: Кластер удалён
        "404":
          description: Кластер не найден

    put:
      tags: [Clusters]
      summary: Обновить конфигурацию кластера
      parameters:
        - $ref: "#/components/parameters/ClusterId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClusterUpdateRequest"
      responses:
        "200":
          description: Кластер обновлён
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cluster"
        "404":
          description: Кластер не найден

  /clusters/{clusterId}/status:
    get:
      tags: [Clusters]
      summary: Состояние кластера (pods, phase, IPFS connectivity)
      parameters:
        - $ref: "#/components/parameters/ClusterId"
      responses:
        "200":
          description: Статус кластера
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClusterStatus"
        "404":
          description: Кластер не найден
  
  /clusters/{clusterId}/nodes:
    get:
      tags: [Clusters]
      summary: Получить список нод в кластере
      parameters:
        - $ref: "#/components/parameters/ClusterId"
      responses:
        "200":
          description: Список нод
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/NodeSpec"

    post:
      tags: [Clusters]
      summary: Добавить новую ноду в кластер
      parameters:
        - $ref: "#/components/parameters/ClusterId"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NodeSpecCreate"
      responses:
        "201":
          description: Нода создана
        "404":
          description: Кластер не найден

  /clusters/{clusterId}/nodes/{nodeId}:
    delete:
      tags: [Clusters]
      summary: Удалить ноду из кластера
      parameters:
        - $ref: "#/components/parameters/ClusterId"
        - $ref: "#/components/parameters/NodeId"
      responses:
        "204":
          description: Нода удалена
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Cluster"
        "404":
          description: Нода не найдена


  /nodes/{nodeId}:
    get:
      tags: [Nodes]
      summary: Получить инфо о ноде
      parameters:
        - $ref: "#/components/parameters/NodeId"
      responses:
        "200":
          description: Информация о ноде
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NodeSpec"
        "404":
          description: Нода или кластер не найдены

    put:
      tags: [Nodes]
      summary: Обновить параметры ноды
      parameters:
        - $ref: "#/components/parameters/NodeId"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NodeSpecUpdate"
      responses:
        "200":
          description: Обновлено
        "404":
          description: Не найдено

  /nodes/{nodeId}/logs:
    get:
      tags: [Nodes]
      summary: Логи IPFS/Cluster для конкретного pod
      parameters:
        - $ref: "#/components/parameters/NodeId"
      responses:
        "200":
          description: Логи ноды
          content:
            text/plain:
              schema:
                type: string
        "404":
          description: Нода не найдена

components:

  parameters:
    ClusterId:
      name: clusterId
      in: path
      required: true
      schema:
        type: string

    NodeId: 
      name: nodeId 
      in: path 
      required: true 
      schema: 
        type: string

  schemas:

    Cluster:
      type: object
      properties:
        clusterId:
          type: string
        clusterName:
          type: string
        replicas:
          type: integer
        serviceType:
          type: string
        storageClass:
          type: string
        clusterStorageSize:
          type: string
        ipfsStorageSize:
          type: string
        images:
          $ref: "#/components/schemas/ImagesSpec"
        configMaps:
          $ref: "#/components/schemas/ConfigMapsSpec"
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/NodeSpec"
        bootstrapPeerID:
          type: string
          readOnly: true
        clusterSecret:
          type: string
          readOnly: true

    ClusterCreateRequest:
      type: object
      required: [clusterName, replicas]
      properties:
        clusterName:
          type: string
        replicas:
          type: integer
          minimum: 1
        clusterStorageSize:
          type: string
        ipfsStorageSize:
          type: string
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/NodeSpecCreate"

    ClusterUpdateRequest:
      type: object
      properties:
        replicas:
          type: integer
        serviceType:
          type: string
        storageClass:
          type: string
        clusterStorageSize:
          type: string
        ipfsStorageSize:
          type: string
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/NodeSpecUpdate"

    ImagesSpec:
      type: object
      properties:
        ipfs:
          type: string
        ipfsCluster:
          type: string

    ConfigMapsSpec:
      type: object
      properties:
        envConfig:
          type: string
        scriptsConfig:
          type: string

    NodeSpec:
      type: object
      properties:
        nodeId:
          type: string
        nodeName:
          type: string
        role:
          type: string
          enum: [bootstrap, worker]
        ports:
          $ref: "#/components/schemas/PortsSpec"
        env:
          type: object
          additionalProperties:
            type: string
        initContainer:
          $ref: "#/components/schemas/InitContainerSpec"
        containers:
          type: array
          items:
            $ref: "#/components/schemas/ContainerSpec"
        volumes:
          $ref: "#/components/schemas/VolumesSpec"

    NodeSpecCreate:
      type: object
      required: [role]
      properties:
        role:
          type: string
          enum: [bootstrap, worker]

    NodeSpecUpdate:
      type: object
      properties:
        ports:
          $ref: "#/components/schemas/PortsSpec"

    PortsSpec:
      type: object
      properties:
        swarmTCP:
          type: integer
        swarmUDP:
          type: integer
        api:
          type: integer
        httpGateway:
          type: integer
        ws:
          type: integer
        clusterAPI:
          type: integer
        clusterProxy:
          type: integer
        clusterSwarm:
          type: integer

    InitContainerSpec:
      type: object
      properties:
        name:
          type: string
        command:
          type: array
          items:
            type: string

    ContainerSpec:
      type: object
      properties:
        name:
          type: string
        image:
          type: string
        command:
          type: array
          items:
            type: string
        ports:
          type: array
          items:
            type: string

    VolumesSpec:
      type: object
      properties:
        ipfsStorage:
          type: string
        clusterStorage:
          type: string
        scriptsConfig:
          type: string

    ClusterStatus:
      type: object
      properties:
        status:
          type: string
          enum: [creating, running, degraded, error]

    NodeStatus:
      type: object
      properties:
        nodeName:
          type: string
        role:
          type: string
          enum: [bootstrap, worker]
        podName:
          type: string
        phase:
          type: string
        ready:
          type: boolean

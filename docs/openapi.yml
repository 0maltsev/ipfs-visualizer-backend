openapi: 3.1.0
info:
  title: IPFS Cluster Topology Orchestrator API
  version: 2.0.0
  description: |
    API оркестратора IPFS-кластера на основе топологии.
    Пользователь создаёт топологию на canvas: узлы и связи между ними.
    Ребро (edge) A → B означает: узел A бустрапится к узлу B (B — bootstrap).
    После сохранения топологию можно задеплоить в Kubernetes.

servers:
  - url: http://localhost:3001/v1
    description: Local Dev

tags:
  - name: Topologies
    description: Топологии сети (узлы + рёбра)
  - name: Deploy
    description: Деплой и статус в Kubernetes

paths:

  /topologies:
    get:
      tags: [Topologies]
      summary: Список всех топологий
      responses:
        "200":
          description: Список топологий
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TopologySummary"

    post:
      tags: [Topologies]
      summary: Создать топологию
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TopologyCreate"
      responses:
        "201":
          description: Топология создана
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Topology"
        "400":
          description: Ошибка валидации

  /topologies/{topologyId}:
    get:
      tags: [Topologies]
      summary: Получить топологию по ID
      parameters:
        - $ref: "#/components/parameters/TopologyId"
      responses:
        "200":
          description: Топология
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Topology"
        "404":
          description: Топология не найдена

    put:
      tags: [Topologies]
      summary: Обновить топологию (узлы и рёбра)
      parameters:
        - $ref: "#/components/parameters/TopologyId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TopologyUpdate"
      responses:
        "200":
          description: Топология обновлена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Topology"
        "400":
          description: Ошибка валидации
        "404":
          description: Топология не найдена

    delete:
      tags: [Topologies]
      summary: Удалить топологию
      parameters:
        - $ref: "#/components/parameters/TopologyId"
      responses:
        "204":
          description: Топология удалена
        "404":
          description: Топология не найдена

  /topologies/{topologyId}/deploy:
    post:
      tags: [Deploy]
      summary: Задеплоить топологию в Kubernetes
      parameters:
        - $ref: "#/components/parameters/TopologyId"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                namespace:
                  type: string
                  default: default
      responses:
        "202":
          description: Деплой запущен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployResult"
        "400":
          description: Некорректная топология (нет bootstrap, циклы и т.д.)
        "404":
          description: Топология не найдена

  /topologies/{topologyId}/undeploy:
    post:
      tags: [Deploy]
      summary: Удалить деплой из Kubernetes
      parameters:
        - $ref: "#/components/parameters/TopologyId"
      responses:
        "202":
          description: Удаление запущено
        "404":
          description: Топология не найдена

  /topologies/{topologyId}/status:
    get:
      tags: [Deploy]
      summary: Статус деплоя топологии
      parameters:
        - $ref: "#/components/parameters/TopologyId"
      responses:
        "200":
          description: Статус деплоя
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeployStatus"
        "404":
          description: Топология не найдена

components:

  parameters:
    TopologyId:
      name: topologyId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:

    TopologySummary:
      type: object
      properties:
        topologyId:
          type: string
          format: uuid
        name:
          type: string
        nodeCount:
          type: integer
        edgeCount:
          type: integer
        deployStatus:
          type: string
          enum: [none, deploying, running, degraded, error]
        createdAt:
          type: string
          format: date-time

    Topology:
      type: object
      properties:
        topologyId:
          type: string
          format: uuid
        name:
          type: string
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/TopologyNode"
        edges:
          type: array
          items:
            $ref: "#/components/schemas/TopologyEdge"
        deployStatus:
          type: string
          enum: [none, deploying, running, degraded, error]
        k8sNamespace:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    TopologyNode:
      type: object
      required: [nodeId, label, position]
      properties:
        nodeId:
          type: string
        label:
          type: string
        position:
          $ref: "#/components/schemas/Position"
        role:
          type: string
          enum: [bootstrap, worker]
          default: worker

    TopologyEdge:
      type: object
      required: [edgeId, sourceNodeId, targetNodeId]
      properties:
        edgeId:
          type: string
        sourceNodeId:
          type: string
          description: Worker (источник) — bootstraps to target
        targetNodeId:
          type: string
          description: Bootstrap (цель) — принимает соединения от source

    Position:
      type: object
      required: [x, y]
      properties:
        x:
          type: number
        y:
          type: number

    TopologyCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/TopologyNode"
          default: []
        edges:
          type: array
          items:
            $ref: "#/components/schemas/TopologyEdge"
          default: []

    TopologyUpdate:
      type: object
      properties:
        name:
          type: string
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/TopologyNode"
        edges:
          type: array
          items:
            $ref: "#/components/schemas/TopologyEdge"

    DeployResult:
      type: object
      properties:
        topologyId:
          type: string
        status:
          type: string
          enum: [deploying]
        message:
          type: string

    DeployStatus:
      type: object
      properties:
        topologyId:
          type: string
        status:
          type: string
          enum: [none, deploying, running, degraded, error]
        message:
          type: string
        pods:
          type: array
          items:
            $ref: "#/components/schemas/PodStatus"

    PodStatus:
      type: object
      properties:
        nodeId:
          type: string
        podName:
          type: string
        phase:
          type: string
        ready:
          type: boolean
